# TCP/IP

## 网络协议

多机之间的数据交流需要协议支撑（进行打包和解包）。协议的分层框架如下：

![](../imgs/a04.png)  

应用层按照协议打包数据，传输层加上双方端口号，网络层加上双方ip地址，链路层加上MAC地址、并将数据拆分成数据帧。经过路由和网关到达目标机器。

- 链路层：以字节为单位把0和1分组，加上源、目标机器物理地址、数据、校验位来传输数据。

  MAC地址为16进制，由管理机构分配+厂商分配

- 网络层：根据 IP 定义网络地址，区分网段。子网内根据地址解析协议（ ARP ) 进行 MAC 寻址， 子网外进行路由转发数据包，这个数据包即 IP 数据包。（？？？）  由于不同硬件对数据帧的最大长度（MTU）限制不同，所以路由器要对IP报文进行分片。

- 传输层：应用程序确认身份之后，将数据包交给其他应用程序。其使用断地是UDP和TCP协议。UDP是面向无连接，是不可靠连接，常用于视频通信、电话会议。TCP是面向连接的，面向连接是有失败重传机制，属于可靠传输。

- 应用层：传输层的数据到达应用层，以规定的协议（SMTP）解读数据。

## IP协议

IP地址在逻辑上进行了网段的划分，属于网络层，功能是在WLAN内路由寻址，选择最佳路由。

IP地址的掩码相同，则说明在同一子网内。

### IP报文

IP报文格式如下：

![](../imgs/a05.png)  

- TTL：数据包的生存时间，每经过一个路由器，TTL值减1。当字段为0，数据包被丢弃。并且发送ICMP报文通知源主机。（防止源主机无休止发送报文）

- 挂载协议标识：标识数据包放置子数据包的协议类型，6-TCP，17-UDP

### TCP

TCP传输控制协议，为了确保端到端间可靠传输，需要对每个字节编号确认、校验数据包的有效性，失败重传。

netstat可以列出连接信息（本地ip端口--目标ip端口）

发送数据前，先建立一条虚拟链路。也就是三次握手，发起连接建立请求时需要打开某个端口等待数据：

![](../imgs/a06.png)  

P24















